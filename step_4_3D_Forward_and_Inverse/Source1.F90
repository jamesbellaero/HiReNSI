!************************************************
! GAUSS-Legendre quadrature nodes
!************************************************
! REVISION : F, 17 Feb 2012

SUBROUTINE GAUSS ( XINT, WINT )
IMPLICIT DOUBLE PRECISION (A-H,O-Z)

DIMENSION XINT(9,9), WINT(9,9)


XINT(1,1) = 0.0D0                                ; WINT(1,1) = 2.0D0
XINT(2,1) = 0.0D0                                ; WINT(2,1) = 0.0D0
XINT(3,1) = 0.0D0                                ; WINT(3,1) = 0.0D0
XINT(4,1) = 0.0D0                                ; WINT(4,1) = 0.0D0

XINT(1,2) = -0.57735026918962576451D0            ; WINT(1,2) = 1.0D0
XINT(2,2) = +0.57735026918962576451D0            ; WINT(2,2) = 1.0D0
XINT(3,2) =  0.0D0                               ; WINT(3,2) = 0.0D0
XINT(4,2) =  0.0D0                               ; WINT(4,2) = 0.0D0

!XINT(1,3) = -0.77459666924148337704D0            ; WINT(1,3) = 0.55555555555555555556D0
!XINT(2,3) =  0.0D0                               ; WINT(2,3) = 0.88888888888888888889D0
!XINT(3,3) = +0.77459666924148337704D0            ; WINT(3,3) = 0.55555555555555555556D0
!XINT(4,3) =  0.0D0                               ; WINT(4,3) = 0.0D0

! Gauss-Lobatto-Legendre quadrature (for 3 points only)
!---------- ---------- ---------- ---------- ----------
XINT(1,3) = -1.0D0                               ; WINT(1,3) = 0.33333333333333333333D0
XINT(2,3) =  0.0D0                               ; WINT(2,3) = 1.33333333333333333333D0
XINT(3,3) = +1.0D0                               ; WINT(3,3) = 0.33333333333333333333D0
XINT(4,3) =  0.0D0                               ; WINT(4,3) = 0.0D0
!---------- ---------- ---------- ---------- ----------

XINT(1,4) = -0.86113631159405257522D0            ; WINT(1,4) = 0.34785484513745385737D0
XINT(2,4) = -0.33998104358485626480D0            ; WINT(2,4) = 0.65214515486254614263D0
XINT(3,4) = +0.33998104358485626480D0            ; WINT(3,4) = 0.65214515486254614263D0
XINT(4,4) = +0.86113631159405257522D0            ; WINT(4,4) = 0.34785484513745385737D0

XINT(1,5) = -0.9061798459386639927976269d0       ; WINT(1,5) = 0.2369268850561890875142640d0
XINT(2,5) = -0.5384693101056830910363144d0       ; WINT(2,5) = 0.4786286704993664680412915d0
XINT(3,5) =  0.0D0                               ; WINT(3,5) = 0.5688888888888888888888889d0
XINT(4,5) = +0.5384693101056830910363144d0       ; WINT(4,5) = 0.4786286704993664680412915d0
XINT(5,5) = +0.9061798459386639927976269d0       ; WINT(5,5) = 0.2369268850561890875142640d0

XINT(1,6) = -0.9324695142031520278123016d0       ; WINT(1,6) = 0.1713244923791703450402961d0
XINT(2,6) = -0.6612093864662645136613996d0       ; WINT(2,6) = 0.3607615730481386075698335d0
XINT(3,6) = -0.2386191860831969086305017d0       ; WINT(3,6) = 0.4679139345726910473898703d0
XINT(4,6) = +0.2386191860831969086305017d0       ; WINT(4,6) = 0.4679139345726910473898703d0
XINT(5,6) = +0.6612093864662645136613996d0       ; WINT(5,6) = 0.3607615730481386075698335d0
XINT(6,6) = +0.9324695142031520278123016d0       ; WINT(6,6) = 0.1713244923791703450402961d0

XINT(1,7) = -0.9491079123427585245261897d0       ; WINT(1,7) = 0.1294849661688696932706114d0
XINT(2,7) = -0.7415311855993944398638648d0       ; WINT(2,7) = 0.2797053914892766679014678d0
XINT(3,7) = -0.4058451513773971669066064d0       ; WINT(3,7) = 0.3818300505051189449503698d0
XINT(4,7) =  0.0d0                               ; WINT(4,7) = 0.4179591836734693877551020d0
XINT(5,7) = +0.4058451513773971669066064d0       ; WINT(5,7) = 0.3818300505051189449503698d0
XINT(6,7) = +0.7415311855993944398638648d0       ; WINT(6,7) = 0.2797053914892766679014678d0
XINT(7,7) = +0.9491079123427585245261897d0       ; WINT(7,7) = 0.1294849661688696932706114d0

XINT(1,8) = -0.9602898564975362316835609d0       ; WINT(1,8) = 0.1012285362903762591525314d0
XINT(2,8) = -0.7966664774136267395915539d0       ; WINT(2,8) = 0.2223810344533744705443560d0
XINT(3,8) = -0.5255324099163289858177390d0       ; WINT(3,8) = 0.3137066458778872873379622d0
XINT(4,8) = -0.1834346424956498049394761d0       ; WINT(4,8) = 0.3626837833783619829651504d0
XINT(5,8) = +0.1834346424956498049394761d0       ; WINT(5,8) = 0.3626837833783619829651504d0
XINT(6,8) = +0.5255324099163289858177390d0       ; WINT(6,8) = 0.3137066458778872873379622d0
XINT(7,8) = +0.7966664774136267395915539d0       ; WINT(7,8) = 0.2223810344533744705443560d0
XINT(8,8) = +0.9602898564975362316835609d0       ; WINT(8,8) = 0.1012285362903762591525314d0

XINT(1,9) = -0.9681602395076260898355762d0       ; WINT(1,9) = 0.0812743883615744119718922d0
XINT(2,9) = -0.8360311073266357942994298d0       ; WINT(2,9) = 0.1806481606948574040584720d0
XINT(3,9) = -0.6133714327005903973087020d0       ; WINT(3,9) = 0.2606106964029354623187429d0
XINT(4,9) = -0.3242534234038089290385380d0       ; WINT(4,9) = 0.3123470770400028400686304d0
XINT(5,9) =  0.0D0                               ; WINT(5,9) = 0.3302393550012597631645251d0
XINT(6,9) = +0.3242534234038089290385380d0       ; WINT(6,9) = 0.3123470770400028400686304d0
XINT(7,9) = +0.6133714327005903973087020d0       ; WINT(7,9) = 0.2606106964029354623187429d0
XINT(8,9) = +0.8360311073266357942994298d0       ; WINT(8,9) = 0.1806481606948574040584720d0
XINT(9,9) = +0.9681602395076260898355762d0       ; WINT(9,9) = 0.0812743883615744119718922d0


RETURN
END


!************************************************
! GAUSS-Lobatto quadrature nodes
!************************************************
! REVISION : F 2 Nov 2012

SUBROUTINE GAUSS_Lobatto ( XINT,WINT )
IMPLICIT DOUBLE PRECISION (A-H,O-Z)

DIMENSION XINT(9,9), WINT(9,9)


! Gauss-Lobatto quadrature
!---------- ---------- ---------- ---------- ----------
XINT(1,1) = 0.0D0                                ; WINT(1,1) = 2.0D0
XINT(2,1) = 0.0D0                                ; WINT(2,1) = 0.0D0
XINT(3,1) = 0.0D0                                ; WINT(3,1) = 0.0D0
XINT(4,1) = 0.0D0                                ; WINT(4,1) = 0.0D0

XINT(1,3) = -1.0D0                               ; WINT(1,3) = 0.33333333333333333333D0
XINT(2,3) =  0.0D0                               ; WINT(2,3) = 1.33333333333333333333D0
XINT(3,3) = +1.0D0                               ; WINT(3,3) = 0.33333333333333333333D0
XINT(4,3) =  0.0D0                               ; WINT(4,3) = 0.0D0


! Gauss-Legendre quadrature
!---------- ---------- ---------- ---------- ----------
XINT(1,4) = -0.86113631159405257522D0            ; WINT(1,4) = 0.34785484513745385737D0
XINT(2,4) = -0.33998104358485626480D0            ; WINT(2,4) = 0.65214515486254614263D0
XINT(3,4) = +0.33998104358485626480D0            ; WINT(3,4) = 0.65214515486254614263D0
XINT(4,4) = +0.86113631159405257522D0            ; WINT(4,4) = 0.34785484513745385737D0

XINT(1,5) = -0.9061798459386639927976269d0       ; WINT(1,5) = 0.2369268850561890875142640d0
XINT(2,5) = -0.5384693101056830910363144d0       ; WINT(2,5) = 0.4786286704993664680412915d0
XINT(3,5) =  0.0D0                               ; WINT(3,5) = 0.5688888888888888888888889d0
XINT(4,5) = +0.5384693101056830910363144d0       ; WINT(4,5) = 0.4786286704993664680412915d0
XINT(5,5) = +0.9061798459386639927976269d0       ; WINT(5,5) = 0.2369268850561890875142640d0

XINT(1,9) = -0.9681602395076260898355762d0       ; WINT(1,9) = 0.0812743883615744119718922d0
XINT(2,9) = -0.8360311073266357942994298d0       ; WINT(2,9) = 0.1806481606948574040584720d0
XINT(3,9) = -0.6133714327005903973087020d0       ; WINT(3,9) = 0.2606106964029354623187429d0
XINT(4,9) = -0.3242534234038089290385380d0       ; WINT(4,9) = 0.3123470770400028400686304d0
XINT(5,9) =  0.0D0                               ; WINT(5,9) = 0.3302393550012597631645251d0
XINT(6,9) = +0.3242534234038089290385380d0       ; WINT(6,9) = 0.3123470770400028400686304d0
XINT(7,9) = +0.6133714327005903973087020d0       ; WINT(7,9) = 0.2606106964029354623187429d0
XINT(8,9) = +0.8360311073266357942994298d0       ; WINT(8,9) = 0.1806481606948574040584720d0
XINT(9,9) = +0.9681602395076260898355762d0       ; WINT(9,9) = 0.0812743883615744119718922d0


RETURN
END


!************************************************
! SOLID ISOPARAMETRIC 8 NODE SHAPE FUNCTIONS
!************************************************

SUBROUTINE SHAPE8 ( XL, YL, FN, DFXI )
IMPLICIT DOUBLE PRECISION (A-H,O-Z)
 
DIMENSION FN(8), DFXI(8,2)

  
FN(1) = 0.25d0 * (1.0d0+XL) * (1.0d0-YL) * (-1.0d0+XL-YL)
FN(2) = 0.25d0 * (1.0d0+XL) * (1.0d0+YL) * (-1.0d0+XL+YL)
FN(3) = 0.25d0 * (1.0d0-XL) * (1.0d0+YL) * (-1.0d0-XL+YL)
FN(4) = 0.25d0 * (1.0d0-XL) * (1.0d0-YL) * (-1.0d0-XL-YL)
FN(5) = 0.50d0 * (1.0d0-YL*YL) * (1.0d0+XL)
FN(6) = 0.50d0 * (1.0d0-XL*XL) * (1.0d0+YL)
FN(7) = 0.50d0 * (1.0d0-YL*YL) * (1.0d0-XL)
FN(8) = 0.50d0 * (1.0d0-XL*XL) * (1.0d0-YL)

DFXI(1,1) =  0.25d0 * (1.0d0-YL) * (2.0d0*XL-YL) 
DFXI(2,1) =  0.25d0 * (1.0d0+YL) * (2.0d0*XL+YL) 
DFXI(3,1) =  0.25d0 * (1.0d0+YL) * (2.0d0*XL-YL) 
DFXI(4,1) =  0.25d0 * (1.0d0-YL) * (2.0d0*XL+YL) 
DFXI(5,1) =  0.50d0 * (1.0d0-YL*YL)
DFXI(6,1) = -1.00d0 * (1.0d0+YL)*XL 
DFXI(7,1) = -0.50d0 * (1.0d0-YL*YL)
DFXI(8,1) = -1.00d0 * (1.0d0-YL)*XL 

DFXI(1,2) =  0.25d0 * (1.0d0+XL) * (-XL+2.0d0*YL) 
DFXI(2,2) =  0.25d0 * (1.0d0+XL) * ( XL+2.0d0*YL) 
DFXI(3,2) =  0.25d0 * (1.0d0-XL) * (-XL+2.0d0*YL) 
DFXI(4,2) =  0.25d0 * (1.0d0-XL) * ( XL+2.0d0*YL) 
DFXI(5,2) = -1.00d0 * (1.0d0+XL) * YL
DFXI(6,2) =  0.50d0 * (1.0d0-XL*XL)
DFXI(7,2) = -1.00d0 * (1.0d0-XL)*YL
DFXI(8,2) = -0.50d0 * (1.0d0-XL*XL)      

RETURN
END


!************************************************
! SOLID ISOPARAMETRIC 9 NODE SHAPE FUNCTIONS
!************************************************
! REVISION : Tue, 14 Feb 2012

SUBROUTINE SHAPE9 ( XL, YL, FN, DFXI )
IMPLICIT DOUBLE PRECISION (A-H,O-Z)
        
DIMENSION FN(9), DFXI(9,2)

        
FN(1) = 0.25d0 *  XL * -YL * (1.0d0+XL) * (1.0d0-YL)
FN(2) = 0.25d0 *  XL *  YL * (1.0d0+XL) * (1.0d0+YL)
FN(3) = 0.25d0 * -XL *  YL * (1.0d0-XL) * (1.0d0+YL)
FN(4) = 0.25d0 * -XL * -YL * (1.0d0-XL) * (1.0d0-YL)
FN(5) = 0.50d0 *  XL *       (1.0d0+XL) *              (1.0d0-YL*YL)
FN(6) = 0.50d0 *        YL *              (1.0d0+YL) * (1.0d0-XL*XL)
FN(7) = 0.50d0 * -XL *       (1.0d0-XL) *              (1.0d0-YL*YL)
FN(8) = 0.50d0 *       -YL *              (1.0d0-YL) * (1.0d0-XL*XL) 
FN(9) = (1.0d0-XL*XL) * (1.0d0-YL*YL)
        
DFXI(1,1) = 0.25D0 * -YL * (1.0d0-YL) * ( 1.0D0 + 2.0D0 * XL)  
DFXI(2,1) = 0.25D0 *  YL * (1.0d0+YL) * ( 1.0D0 + 2.0D0 * XL)
DFXI(3,1) = 0.25D0 *  YL * (1.0d0+YL) * (-1.0D0 + 2.0D0 * XL)
DFXI(4,1) = 0.25D0 * -YL * (1.0d0-YL) * (-1.0D0 + 2.0D0 * XL)
DFXI(5,1) = 0.50D0 * (1.0d0-YL*YL) * ( 1.0D0 + 2.0D0 * XL)
DFXI(6,1) =  YL * (1.0d0+YL) * -XL 
DFXI(7,1) = 0.50D0 * (1.0d0-YL*YL) * (-1.0D0 + 2.0D0 * XL)
DFXI(8,1) = -YL * (1.0d0-YL) * -XL
DFXI(9,1) = -2.0D0 * XL * (1.0d0-YL*YL) 
        
DFXI(1,2) = 0.25D0 *  XL * (1.0d0+XL) * (-1.0D0 + 2.0D0 * YL)
DFXI(2,2) = 0.25D0 *  XL * (1.0d0+XL) * ( 1.0D0 + 2.0D0 * YL)
DFXI(3,2) = 0.25D0 * -XL * (1.0d0-XL) * ( 1.0D0 + 2.0D0 * YL)
DFXI(4,2) = 0.25D0 * -XL * (1.0d0-XL) * (-1.0D0 + 2.0D0 * YL)
DFXI(5,2) =  XL * (1.0d0+XL) * -YL
DFXI(6,2) = 0.50D0 * (1.0d0-XL*XL) * ( 1.0D0 + 2.0D0 * YL)
DFXI(7,2) = -XL * (1.0d0-XL) * -YL
DFXI(8,2) = 0.50D0 * (1.0d0-XL*XL) * (-1.0D0 + 2.0D0 * YL)
DFXI(9,2) = -2.0D0 * YL * (1.0d0-XL*XL)

        
RETURN
END


!************************************************
! Cross product of two vectors: VN = VR x VS
!************************************************

! REVISION : Sat, 19 May 2012

SUBROUTINE CROSS ( VR, VS, VN )
IMPLICIT DOUBLE PRECISION (A-H,O-Z)


! in
!---------- ---------- ---------- ---------- ----------
DIMENSION VR(3), VS(3)
!---------- ---------- ---------- ---------- ----------


! out
!---------- ---------- ---------- ---------- ----------
DIMENSION VN(3)
!---------- ---------- ---------- ---------- ----------


VN(1) = +VR(2) * VS(3) - VR(3) * VS(2)
VN(2) = -VR(1) * VS(3) + VR(3) * VS(1)
VN(3) = +VR(1) * VS(2) - VR(2) * VS(1)


RETURN
END


!************************************************
! NORM OF A VECTOR: |V|
!************************************************

! REVISION : Sat, 19 May 2012

SUBROUTINE NORM (V, N, VNORM )
IMPLICIT DOUBLE PRECISION (A-H,O-Z)


! in
!---------- ---------- ---------- ---------- ----------
DIMENSION V(N)
!---------- ---------- ---------- ---------- ----------


VNORM = 0.0d0

DO I = 1, N
   VNORM = VNORM + V(I)**2
END DO

VNORM = DSQRT(VNORM)


RETURN
END


!************************************************
! HRZ mass diagonalization
! for PML formulation, certain matrices can be zero. therefore, one should be careful with dividing by zero. that's why we have TOL here.
!************************************************

! REVISION : F, 3 August 2012

SUBROUTINE HRZ_Mass_Diagonalization ( EM, N_blocks, EDIAG_M )
USE PARAMETERS
IMPLICIT DOUBLE PRECISION (A-H,O-Z)


! in
!---------- ---------- ---------- ---------- ----------
DIMENSION EM(NNODE * N_blocks, NNODE * N_blocks)
!---------- ---------- ---------- ---------- ----------


! out
!---------- ---------- ---------- ---------- ----------
DIMENSION EDIAG_M(NNODE * N_blocks)
!---------- ---------- ---------- ---------- ----------


! initialize
!---------- ---------- ---------- ---------- ---------- 
TOL              = 1.0d-12
EDIAG_M          = 0.0d0
ETOTAL_MASS      = 0.0d0
ETOTAL_DIAG_MASS = 0.0d0


DO I = 1 , NNODE

   DO J = 1 , NNODE
      ETOTAL_MASS = ETOTAL_MASS + EM(I,J)
   END DO
   ETOTAL_DIAG_MASS  = ETOTAL_DIAG_MASS + EM(I,I)

END DO


IF ( ETOTAL_DIAG_MASS < 0.0d0 ) THEN
   WRITE(*,*) 'Negative mass in HRZ_Mass_Diagonalization'
   STOP
END IF


DO I = 1 , NNODE * N_blocks
   IF ( ETOTAL_DIAG_MASS > TOL ) THEN
      EDIAG_M(I) = ( EM(I,I) / ETOTAL_DIAG_MASS ) * ETOTAL_MASS
   ELSE
      EDIAG_M(I) = 0.0d0                         ! this happens in PML since c=0 in sides and at the bottom
!      WRITE(*,*) 'Zero diagonal mass in HRZ_Mass_Diagonalization'
!      PAUSE
   END IF
END DO


idebug = 9
if (idebug == 96) then
   do i=1,16
      write(*,'(i3,e10.3)') i, ediag_m(i)
   end do

   do i= 1,16
      write(*,'(15e10.3,1e9.2)')  (em(i,j),j=1,16)
   end do

   pause
end if


! a  D I R T Y  temporary shortcut
!---------- ---------- ---------- ---------- ----------
I_Brutality = 1
IF ( I_Brutality == 1 ) THEN

   EM = 0.0d0

   DO I = 1 , NNODE * N_blocks
      EM(I,I) = EDIAG_M(I)
   END DO

END IF
!---------- ---------- ---------- ---------- ----------


RETURN
END


!************************************************
! Extract the diagonal of a matrix
! the matrix should be already diagonal (e.g. spectral element mass matrix)
!************************************************

! REVISION : M 16 July 2012

SUBROUTINE Extract_Diagonal ( EM, N, EDIAG_M )
IMPLICIT DOUBLE PRECISION (A-H,O-Z)


! in
!---------- ---------- ---------- ---------- ----------
DIMENSION EM(N, N)
!---------- ---------- ---------- ---------- ----------


! out
!---------- ---------- ---------- ---------- ----------
DIMENSION EDIAG_M(N)
!---------- ---------- ---------- ---------- ----------


DO I = 1, N
   EDIAG_M(I) =  EM(I,I) 
END DO


RETURN
END

